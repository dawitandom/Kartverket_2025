@*
    Skjema for å opprette ny hindring-rapport.
    Kun tilgjengelig for piloter (User rolle).
    Inneholder interaktivt kart (Leaflet) for å velge lokasjon.
    Validerer input på klient-side (HTML5) og server-side (Data Annotations).
*@

@model FirstWebApplication.Models.Report

@{
ViewData["Title"] = "Create New Report";
}

<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        border: 2px solid #ddd;
        margin-bottom: 20px;
    }

    .location-btn {
        margin-bottom: 10px;
    }

    .coordinates-display {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    @@media (max-width: 768px) {
        #map {
            height: 450px;
        }
    }
</style>

<div class="container mt-4">
    <h2>Create New Obstacle Report</h2>

    @* Viser valideringsfeil hvis skjema er ugyldig *@
    @if (!ViewData.ModelState.IsValid)
    {
    <div class="alert alert-danger" role="alert">
        <h5>Please correct the following errors:</h5>
        <div asp-validation-summary="All"></div>
    </div>
    }

    <form asp-action="Scheme" method="post">

        @* UserId - skjult felt, settes automatisk i controller *@
        <input asp-for="UserId" type="hidden" />

        @* Lokasjon-seksjon med interaktivt kart *@
        <div class="card mb-4">
            <div class="card-header">
                <h5>Location</h5>
            </div>
            <div class="card-body">
                @* Knapp for GPS-lokasjon *@
                <button type="button" id="useMyLocation" class="btn btn-success location-btn">
                    Use My Current Location
                </button>
                @* Knapp for å fjerne lokasjon *@
                <button type="button" id="clearLocation" class="btn btn-outline-secondary location-btn">
                    Clear Location
                </button>

                @* Viser valgte koordinater *@
                <div class="coordinates-display">
                    <strong>Selected Coordinates:</strong>
                    <span id="coordsDisplay">Click on the map or use your location</span>
                </div>

                @* Leaflet kart *@
                <div id="map"></div>

                @* Hidden felter for koordinater *@
                <input asp-for="Latitude" type="hidden" id="latitudeHidden" />
                <input asp-for="Longitude" type="hidden" id="longitudeHidden" />

                @* Manuelle koordinat-felter *@
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="control-label">Latitude (manual)</label>
                        <input type="text" class="form-control" id="latitudeManual" placeholder="59.911491" />
                        <span asp-validation-for="Latitude" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label class="control-label">Longitude (manual)</label>
                        <input type="text" class="form-control" id="longitudeManual" placeholder="10.757933" />
                        <span asp-validation-for="Longitude" class="text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        @* Høyde-felt (valgfritt) *@
        <div class="form-group mb-3">
            <label asp-for="AltitudeFeet" class="control-label">Altitude (feet)</label>
            <input asp-for="AltitudeFeet" class="form-control" type="number" />
            <span asp-validation-for="AltitudeFeet" class="text-danger"></span>
            <small class="form-text text-muted">Optional</small>
        </div>

        @* Dropdown for hindring-type *@
        <div class="form-group mb-3">
            <label asp-for="ObstacleId" class="control-label">Obstacle Type *</label>
            <select asp-for="ObstacleId" class="form-control" asp-items="ViewBag.ObstacleTypes">
                <option value="">-- Select Obstacle Type --</option>
            </select>
            <span asp-validation-for="ObstacleId" class="text-danger"></span>
        </div>

        @* Beskrivelse (påkrevd, 10-5000 tegn) *@
        <div class="form-group mb-3">
            <label asp-for="Description" class="control-label">Description *</label>
            <textarea asp-for="Description" class="form-control" rows="5" placeholder="Describe the obstacle in detail (minimum 10 characters)"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
            <small class="form-text text-muted">Minimum 10 characters, maximum 5000</small>
        </div>

        @* Submit og Cancel knapper *@
        <div class="form-group mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                Submit Report
            </button>
            <a asp-action="MyReports" class="btn btn-secondary btn-lg">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
<partial name="_ValidationScriptsPartial" />

<script>
    // Initialiserer Leaflet kart sentrert på Oslo
    const map = L.map('map').setView([59.911491, 10.757933], 13);

    // Legger til OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    let marker = null;

    // Funksjon som oppdaterer koordinater i alle felter
    function updateCoordinates(lat, lng) {
        lat = parseFloat(lat.toFixed(9));
        lng = parseFloat(lng.toFixed(9));

        const latStr = lat.toString().replace(',', '.');
        const lngStr = lng.toString().replace(',', '.');

        // Oppdater hidden felter (sendes til server)
        document.getElementById('latitudeHidden').value = latStr;
        document.getElementById('longitudeHidden').value = lngStr;
        document.getElementById('latitudeManual').value = latStr;
        document.getElementById('longitudeManual').value = lngStr;

        // Oppdater visningstekst
        document.getElementById('coordsDisplay').innerHTML =
            `Lat: <strong>${lat.toFixed(6)}</strong>, Lon: <strong>${lng.toFixed(6)}</strong>`;

        // Oppdater eller opprett markør
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }

        map.setView([lat, lng], 13);
    }

    // Klikk på kartet setter koordinater
    map.on('click', function(e) {
        updateCoordinates(e.latlng.lat, e.latlng.lng);
    });

    // "Use My Current Location" knapp - bruker GPS
    document.getElementById('useMyLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            const originalText = this.innerHTML;
            this.innerHTML = 'Getting location...';
            this.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateCoordinates(position.coords.latitude, position.coords.longitude);
                    this.innerHTML = originalText;
                    this.disabled = false;
                },
                (error) => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                    alert('Could not get your location. Please check your browser permissions.');
                    console.error(error);
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });

    // "Clear Location" knapp - fjerner koordinater
    document.getElementById('clearLocation').addEventListener('click', function() {
        document.getElementById('latitudeHidden').value = '';
        document.getElementById('longitudeHidden').value = '';
        document.getElementById('latitudeManual').value = '';
        document.getElementById('longitudeManual').value = '';
        document.getElementById('coordsDisplay').innerHTML = 'Click on the map or use your location';

        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
    });

    // Latitude manuell input - oppdater kart
    document.getElementById('latitudeManual').addEventListener('change', function() {
        const latStr = this.value.replace(',', '.');
        const lngStr = document.getElementById('longitudeManual').value.replace(',', '.');
        const lat = parseFloat(latStr);
        const lng = parseFloat(lngStr);

        if (!isNaN(lat) && !isNaN(lng)) {
            updateCoordinates(lat, lng);
        }
    });

    // Longitude manuell input - oppdater kart
    document.getElementById('longitudeManual').addEventListener('change', function() {
        const latStr = document.getElementById('latitudeManual').value.replace(',', '.');
        const lngStr = this.value.replace(',', '.');
        const lat = parseFloat(latStr);
        const lng = parseFloat(lngStr);

        if (!isNaN(lat) && !isNaN(lng)) {
            updateCoordinates(lat, lng);
        }
    });
</script>
}