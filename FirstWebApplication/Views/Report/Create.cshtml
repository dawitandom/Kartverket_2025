@*
    Skjema for å opprette ny hindring-rapport.
    Kun tilgjengelig for piloter (User rolle).
    Inneholder interaktivt kart (Leaflet) for å velge lokasjon.
    Validerer input på klient-side (HTML5) og server-side (Data Annotations).
*@
@model FirstWebApplication.Models.Report 

@{
    ViewData["Title"] = "Create a new obstacle report";
}

@section Styles {
<link rel="stylesheet" href="~/css/create.css" asp-append-version="true" />
}

<div class="container mt-4">
  <h2>Create a new obstacle report</h2>

  @if (!ViewData.ModelState.IsValid)
  {
      <div class="alert alert-danger" role="alert">
          <h5>Please correct the following errors:</h5>
          <div asp-validation-summary="All"></div>
      </div>
  }

  <form id="reportForm" asp-action="Create" method="post">
    @Html.AntiForgeryToken()
    <input asp-for="UserId" type="hidden" /> 

    <!-- 1) LOCATION -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Location</h5>
      </div>
      <div class="card-body">
        <button type="button" id="useMyLocation" class="btn btn-success location-btn">Use My Current Location</button>
        <button type="button" id="clearLocation" class="btn btn-danger text-white location-btn">Clear Location</button>

        <div class="coordinates-display">
          <strong>Selected Coordinates:</strong>
          <span id="coordsDisplay">Click on the map or use your location</span>
        </div>

        <!-- Map + custom vertical toolbars (icons only) -->
        <div class="map-wrap">
          <!-- Right (top) tools -->
          <div class="map-tools">
            <button type="button" id="tool-line"  class="tool" title="Line">
              <text>
                <svg viewBox="0 0 24 24"><path d="M4 18l6-6 4 4 6-10" fill="none" stroke="currentColor" stroke-width="2"/></svg>
              </text>
            </button>
            <button type="button" id="tool-circle" class="tool" title="Circle">
              <text>
                <svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2" />
                </svg>
              </text>
            </button>
            <button type="button" id="tool-rect"  class="tool" title="Rectangle">
              <text>
                <svg viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="12" stroke="currentColor" fill="none" stroke-width="2"/></svg>
              </text>
            </button>
          </div>

          <!-- Right (bottom) tools: Edit / Finish / Delete -->
          <div class="map-tools secondary">
            <button type="button" id="tool-edit" class="tool" title="Edit">
              <text>
                <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75z" fill="currentColor"/></svg>
              </text>
            </button>
            <button type="button" id="tool-edit-done" class="tool" title="Finish edit">
              <text>
                <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" fill="none"/></svg>
              </text>
            </button>
          </div>  

          <!-- SINGLE map element -->
          <div id="map"></div>
        </div>
        
        <!-- Feilmelding hvis ikke location er plassert -->
        <div id="positionError" class="alert alert-danger mt-3 d-none">
          Please select a location on the map before saving or submitting.
        </div>
        
        <!-- Hidden felter som binder til modellen -->
        <input asp-for="Latitude"  type="hidden" id="latitudeHidden" />
        <input asp-for="Longitude" type="hidden" id="longitudeHidden" />
        <input asp-for="Geometry" type="hidden" id="geometryHidden" />


        <!-- Manuelle koordinater -->
        <div class="row mt-3">
          <div class="col-md-6">
            <label class="control-label">Latitude (manual)</label>
            <input type="text" class="form-control" id="latitudeManual" placeholder="59.911491" />
            <span asp-validation-for="Latitude" class="text-danger"></span>
          </div>
          <div class="col-md-6">
            <label class="control-label">Longitude (manual)</label>
            <input type="text" class="form-control" id="longitudeManual" placeholder="10.757933" />
            <span asp-validation-for="Longitude" class="text-danger"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 2) Height -->
    <div class="form-group mb-3">
      <label asp-for="HeightFeet" class="control-label">Height (feet)</label>
      <input asp-for="HeightFeet" class="form-control" type="number" min="0" max="20000" step="1" inputmode="numeric" placeholder="e.g. 500" />
      <span asp-validation-for="HeightFeet" class="text-danger"></span>
      <small class="form-text text-muted">Optional — enter a whole number between 0 and 20,000</small>
    </div>

    <!-- 3) OBSTACLE TYPE -->
    <div class="form-group mb-3">
      <div class="d-flex align-items-center gap-2 mb-1">
        <label asp-for="ObstacleId" class="control-label">Obstacle Type *</label>
        <button id="obstaclePopoverBtn" type="button" class="info-btn" data-bs-html="true" aria-label="Obstacle types information" title="Obstacle types">
          <span>i</span>
        </button>
      </div>

      <select asp-for="ObstacleId" class="form-control" asp-items="ViewBag.ObstacleTypes">
        <option value="">-- Select Obstacle Type --</option>
      </select>
      <span asp-validation-for="ObstacleId" class="text-danger"></span>
    </div>

    <!-- 4) DESCRIPTION -->
    <div class="form-group mb-3">
      <label asp-for="Description" class="control-label">Description *</label>
      <textarea asp-for="Description" class="form-control" rows="5" placeholder="Describe the obstacle in detail (minimum 10 characters)"></textarea>
      <span asp-validation-for="Description" class="text-danger"></span>
      <small class="form-text text-muted">Minimum 10 characters, maximum 5000</small>
    </div>

    <!-- 5) KNAPPER -->
    <div class="form-group mt-4 d-flex gap-2">
      <button type="submit"
              name="submitAction"
              value="save"
              formnovalidate
              class="btn btn-secondary">
        Save changes
      </button>

      <button type="submit"
              name="submitAction"
              value="submit"
              class="btn btn-primary">
        Submit
      </button>
      <a asp-action="MyReports" class="btn btn-outline-secondary btn-lg">Back</a>
    </div>
  </form>
  </div>

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script src="~/js/map.report.create.js" asp-append-version="true"></script>
  <script src="~/js/obstacle.popover.js" asp-append-version="true"></script>
}