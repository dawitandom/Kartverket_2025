@using System.Security.Claims
@model FirstWebApplication.Models.Report
@{
    ViewData["Title"] = "Registrar - Details";
    string obstacleName = Model?.ObstacleType?.ObstacleName ?? Model?.ObstacleId ?? "-";
    string status = string.IsNullOrWhiteSpace(Model?.Status) ? "Pending" : Model.Status!;
    string createdAt = (Model?.DateTime == default ? null : Model?.DateTime)?.ToString("dd.MM.yyyy HH:mm") ?? "-";
    string lastUpdated = Model?.LastUpdated?.ToString("dd.MM.yyyy HH:mm") ?? null;
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    // compute current URL to return back to the same page after status change
    var currentUrl = Context.Request.Path + Context.Request.QueryString;
}

<style>
    /* Map visible when coordinates exist, with smooth expand/collapse like Details view */
    #detailMap {
        width: 100%;
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        transition: height 250ms ease;
        box-shadow: 0 6px 16px rgba(0,0,0,.08);
        border: 1px solid #eef2f7;
    }

    #detailMap.expanded {
        height: 80vh;
    }

    @@media (max-width: 991px) {
        #detailMap {
            height: 320px;
        }

        #detailMap.expanded {
            height: 75vh;
        }
    }

    /* Status control styling to make it larger / more visible */
    .status-control {
        min-width: 260px;
        display: inline-block;
        vertical-align: middle;
    }

    .status-label {
        display: inline-block;
        margin-right: .5rem;
        font-weight: 600;
        color: #334155; /* slightly darker label */
    }

    .status-select-lg {
        box-shadow: 0 6px 16px rgba(2,6,23,.06);
        border: 1px solid rgba(2,6,23,.08);
        font-size: 1.02rem;
        padding: .5rem .75rem;
    }

    /* make change button more prominent */
    .status-change-btn {
        min-width: 140px;
    }
</style>

<div class="details-page container-narrow">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><i class="bi bi-info-circle"></i> Registrar Details</h2>
    </div>

    @* MAP: render only if coordinates exist *@
    @if (Model?.Latitude.HasValue == true && Model?.Longitude.HasValue == true)
    {
        <div id="mapWrap" class="mb-3">
            <div id="detailMap" class="rounded shadow-sm"></div>
        </div>
    }
    else
    {
        <div class="alert alert-light border d-flex align-items-center gap-2 mb-3">
            <i class="bi bi-info-circle"></i>
            <div>No map available – coordinates are missing.</div>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="h5 mb-0">
                Report <span class="text-muted">#@Model?.ReportId</span>
            </div>
            <span class="badge @(string.IsNullOrWhiteSpace(status) ? "text-bg-secondary" : (status.ToLower() == "approved" ? "text-bg-success" : status.ToLower() == "rejected" ? "text-bg-danger" : "text-bg-secondary")) px-3 py-2">@status</span>
        </div>

        <div class="card-body">
            <dl class="row dl-clean mb-0">
                <dt class="col-12 col-md-4">Obstacle type</dt>
                <dd class="col-12 col-md-8">@obstacleName</dd>

                <dt class="col-12 col-md-4">Description</dt>
                <dd class="col-12 col-md-8">@Model?.Description</dd>

                <dt class="col-12 col-md-4">Coordinates</dt>
                <dd class="col-12 col-md-8">
                    @{
                        var hasLat = Model?.Latitude.HasValue == true;
                        var hasLng = Model?.Longitude.HasValue == true;
                        if (hasLat && hasLng)
                        {
                            <span>@($"{Model.Latitude:F6}, {Model.Longitude:F6}")</span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    }
                </dd>

                <dt class="col-12 col-md-4">Altitude (ft)</dt>
                <dd class="col-12 col-md-8">@((Model?.HeightFeet.HasValue == true) ? Model.HeightFeet : "-")</dd>

                <dt class="col-12 col-md-4">Created</dt>
                <dd class="col-12 col-md-8">@createdAt</dd>

                @if (!string.IsNullOrWhiteSpace(lastUpdated))
                {
                    <dt class="col-12 col-md-4">Last updated</dt>
                    <dd class="col-12 col-md-8">@lastUpdated</dd>
                }

                <dt class="col-12 col-md-4">Status</dt>
                <dd class="col-12 col-md-8">@status</dd>
            </dl>

            <hr class="my-4" />

            <div class="d-flex flex-wrap gap-2 align-items-center">
                <a asp-action="ReviewedReports" class="btn btn-secondary">
                    <i class="bi bi-list-ul"></i> Back to Reviewed Reports
                </a>

                @* Registrar (and Admin) get an Edit button on the registrar-specific details page *@
                @if (User.IsInRole("Registrar") || User.IsInRole("Admin"))
                {
                    <a asp-action="Edit" asp-route-id="@Model?.ReportId" class="btn btn-outline-primary">
                        <i class="bi bi-pencil-square"></i> Edit
                    </a>
                }

                @* Only Admin may delete (controller enforces this) *@
                @if (User.IsInRole("Admin"))
                {
                    <form asp-action="Delete" asp-route-id="@Model?.ReportId" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Delete report @Model?.ReportId?');">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </form>
                }

                @* Status change dropdown for Registrar/Admin (bigger & dynamic button) *@
                @if (User.IsInRole("Registrar") || User.IsInRole("Admin"))
                {
                    <form asp-action="UpdateStatus" method="post" class="d-inline ms-2" id="statusChangeForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model?.ReportId" />
                        <input type="hidden" name="returnUrl" value="@currentUrl" />

                        <label for="newStatus" class="status-label visually-hidden">Change status</label>
                        <div class="status-control">
                            @{
                                var statuses = new[] { "Pending", "Approved", "Rejected", "Draft" };
                            }
                            <select id="newStatus" name="newStatus" class="form-select status-select-lg" aria-label="Change report status">
                                @foreach (var s in statuses)
                                {
                                    if (string.Equals(s, status, StringComparison.OrdinalIgnoreCase))
                                    {
                                        <option value="@s" selected>@s</option>
                                    }
                                    else
                                    {
                                        <option value="@s">@s</option>
                                    }
                                }
                            </select>
                        </div>

                        <button id="statusChangeBtn" type="submit" class="btn status-change-btn btn-lg btn-outline-primary ms-2">
                            Change
                        </button>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Only attempt to load Leaflet and init map if the DOM elements exist
            function loadLeaflet(cb) {
                if (window.L) { cb(); return; }
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
                var s = document.createElement('script');
                s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                s.onload = cb;
                document.body.appendChild(s);
            }

            const wrap = document.getElementById('mapWrap');
            const mapEl = document.getElementById('detailMap');
            if (!wrap || !mapEl) {
                // still initialize status UI even if no map
                initStatusUI();
                return;
            }

            const lat = parseFloat("@(Model!.Latitude!.Value.ToString(System.Globalization.CultureInfo.InvariantCulture))");
            const lng = parseFloat("@(Model!.Longitude!.Value.ToString(System.Globalization.CultureInfo.InvariantCulture))");

            let map;

            function initMap() {
                map = L.map(mapEl, { zoomControl: true }).setView([lat, lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);
                L.marker([lat, lng]).addTo(map);

                // Ensure correct size after first render (Safari/iPad)
                setTimeout(() => map.invalidateSize(), 120);

                // Click/tap: toggle expanded view
                mapEl.addEventListener('click', function () {
                    mapEl.classList.toggle('expanded');
                    setTimeout(() => map.invalidateSize(), 260);
                }, { passive: true });

                // initialize status UI after map ready
                initStatusUI();
            }

            loadLeaflet(initMap);

            // Status UI: make the control more visible and change button text/class based on selection
            function initStatusUI() {
                var select = document.getElementById('newStatus');
                var btn = document.getElementById('statusChangeBtn');

                if (!select || !btn) return;

                var mapping = {
                    "Approved": { text: "Approve", classes: "btn btn-success status-change-btn btn-lg" },
                    "Rejected": { text: "Reject", classes: "btn btn-danger status-change-btn btn-lg" },
                    "Draft":    { text: "Save as Draft", classes: "btn btn-secondary status-change-btn btn-lg" },
                    "Pending":  { text: "Set Pending", classes: "btn btn-primary status-change-btn btn-lg" }
                };

                function applyState() {
                    var val = select.value;
                    var m = mapping[val] || { text: "Change", classes: "btn btn-outline-primary status-change-btn btn-lg" };
                    btn.textContent = m.text;
                    btn.className = m.classes + " ms-2";
                }

                // initial
                applyState();

                // update on change
                select.addEventListener('change', applyState, { passive: true });

                // confirmation before submit (optional): show confirm for destructive actions
                document.getElementById('statusChangeForm')?.addEventListener('submit', function (e) {
                    var val = select.value;
                    if (val === "Rejected") {
                        if (!confirm('Are you sure you want to reject this report?')) {
                            e.preventDefault();
                        }
                    }
                });
            }
        })();
    </script>
}